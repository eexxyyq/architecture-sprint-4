# Выбор и настройка мониторинга в системе

## Мотивация

Для эффективного анализа производительности и своевременного обнаружения проблем необходим мониторинг различных метрик системы. Он позволит:

- **Раннее выявление проблем**: мониторинг поможет обнаружить аномалии и проблемы в работе системы до того, как они затронут пользователей.
- **Оперативное принятие решений**: данные мониторинга позволят техническим специалистам быстрее реагировать на сбои, оптимизировать ресурсы и избегать длительных простоев.
- **Оптимизация производительности**: своевременные данные о загруженности API, базы данных и других компонентов позволят оптимизировать инфраструктуру и избежать ее перегрузки.
- **Прозрачность бизнес-процессов**: мониторинг метрик, таких как количество успешных и неуспешных запросов, поможет бизнесу лучше понять потребности пользователей и работать над улучшением качества услуг.

## Стратегия мониторинга: Четыре золотых сигнала

Предлагается использовать подход **"Четыре золотых сигнала"** для мониторинга, так как этот подход охватывает все ключевые аспекты, которые должны быть под контролем в распределенных системах:

1. **Latency (Задержка)**: время, которое требуется для выполнения запроса или обработки события.
2. **Traffic (Трафик)**: количество запросов, операций или транзакций, которые проходят через систему.
3. **Errors (Ошибки)**: количество неудачных операций или сбоев в системе.
4. **Saturation (Насыщенность)**: степень загрузки или использования ресурсов в системе.

Эти сигналы позволяют оперативно выявлять проблемы и быстро принимать меры для их решения.

## Выбор метрик для мониторинга

### 1. Метрики для API

#### Интернет-магазин API
- **Number of requests (RPS)**:
    - **Зачем**: отслеживание объема входящих запросов помогает понять нагрузку на сервис.
    - **Золотой сигнал**: **Traffic**.
    - **Ярлыки**: `endpoint`, `status_code`, `user_type`.

- **Response time (latency)**:
    - **Зачем**: измерение времени отклика API помогает выявить задержки и узкие места.
    - **Золотой сигнал**: **Latency**.
    - **Ярлыки**: `endpoint`, `user_type`.

- **Number of HTTP 500 errors**:
    - **Зачем**: отслеживание ошибок сервера для своевременной реакции на сбои.
    - **Золотой сигнал**: **Errors**.
    - **Ярлыки**: `endpoint`, `status_code`.

#### CRM API
- **Number of requests (RPS)**:
    - **Зачем**: отслеживание количества запросов на CRM помогает понять нагрузку.
    - **Золотой сигнал**: **Traffic**.
    - **Ярлыки**: `user_type`, `status_code`.

- **Response time (latency)**:
    - **Зачем**: измерение времени отклика помогает выявить проблемы с производительностью.
    - **Золотой сигнал**: **Latency**.
    - **Ярлыки**: `user_type`.

#### MES API
- **Number of requests (RPS)**:
    - **Зачем**: отслеживание нагрузки на MES помогает контролировать его производительность.
    - **Золотой сигнал**: **Traffic**.
    - **Ярлыки**: `status_code`.

- **Response time (latency)**:
    - **Зачем**: мониторинг времени отклика для критически важного бизнес-сервиса.
    - **Золотой сигнал**: **Latency**.
    - **Ярлыки**: `user_type`.

### 2. Метрики для Баз данных

#### Shop DB
- **Memory Utilisation**:
    - **Зачем**: отслеживание использования памяти базы данных для предотвращения переполнения.
    - **Золотой сигнал**: **Saturation**.
    - **Ярлыки**: `db_type`.

- **Number of connections**:
    - **Зачем**: отслеживание числа соединений для предотвращения ошибок соединения.
    - **Золотой сигнал**: **Saturation**.
    - **Ярлыки**: `db_type`.

#### MES DB
- **Memory Utilisation**:
    - **Зачем**: позволяет следить за состоянием памяти и избежать перегрузки.
    - **Золотой сигнал**: **Saturation**.
    - **Ярлыки**: `db_type`.

- **Number of connections**:
    - **Зачем**: контроль за числом подключений помогает предотвратить ошибки при соединении с базой.
    - **Золотой сигнал**: **Saturation**.
    - **Ярлыки**: `db_type`.

### 3. Метрики для Очередей сообщений (RabbitMQ)

- **Number of dead-letter-exchange letters**:
    - **Зачем**: отслеживание сообщений, которые не могут быть доставлены, для предотвращения потери данных.
    - **Золотой сигнал**: **Errors**.
    - **Ярлыки**: `queue_type`, `status_code`.

- **Number of messages in flight**:
    - **Зачем**: измерение числа сообщений в процессе обработки для контроля нагрузки.
    - **Золотой сигнал**: **Traffic**.
    - **Ярлыки**: `queue_type`.

### 4. Метрики для Использования ресурсов

- **CPU % for shop API**:
    - **Зачем**: мониторинг загрузки процессора для предотвращения перегрузок.
    - **Золотой сигнал**: **Saturation**.
    - **Ярлыки**: `service_name`, `region`.

- **Memory Utilisation for shop API**:
    - **Зачем**: контроль использования памяти для предотвращения сбоев из-за нехватки ресурсов.
    - **Золотой сигнал**: **Saturation**.
    - **Ярлыки**: `service_name`, `region`.

---


### План действий:
1. Создать сервер Prometheus.
2. Добавить библиотеки `prometheus-metrics-exporter-pushgateway` во все разрабатываемые приложения.
3. Развернуть Prometheus-экспортеры для сторонних приложений (базы данных, брокер, S3).
4. Развернуть сервер Grafana.
5. Настроить источники данных для Grafana.
